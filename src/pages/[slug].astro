---
import { loadQuery } from '../sanity/lib/load-query';
import { pageQuery } from '../sanity/lib/queries';
import Layout from "../layouts/Layout.astro";
import HeroBlock from "../components/HeroBlock.astro";
import SplitImageBlock from "../components/SplitImageBlock.astro";
import FeaturesBlock from "../components/FeaturesBlock.astro";
import FaqsBlock from "../components/FaqsBlock.astro";

const { slug } = Astro.params;
const { data: pageData, perspective } = await loadQuery({
  query: pageQuery,
  params: { slug },
  cookies: Astro.cookies
});

const isDraftMode = perspective === 'previewDrafts';

if (!pageData || !pageData.content || !Array.isArray(pageData.content)) {
     if (!isDraftMode) {
       return Astro.redirect('/404');
     }
   }

// Mapear los componentes a los bloques
const blockComponents = {
  hero: HeroBlock,
  splitImage: SplitImageBlock,
  features: FeaturesBlock,
  faqs: FaqsBlock,
};
---
<Layout>
  {pageData.content.map((bloque) => {
    const BlockComponent = blockComponents[bloque._type];
    return BlockComponent ? (
      <BlockComponent {...bloque} />
    ) : null;
  })}
</Layout>
