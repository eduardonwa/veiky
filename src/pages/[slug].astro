---
import { loadQuery } from '../sanity/lib/load-query';
import { pageQuery } from '../sanity/lib/queries';
import Layout from "../layouts/Layout.astro";
import HeroBlock from "../components/HeroBlock.astro";
import SplitImageBlock from "../components/SplitImageBlock.astro";
import FeaturesBlock from "../components/FeaturesBlock.astro";
import FaqsBlock from "../components/FaqsBlock.astro";

const { slug } = Astro.params;
const { data: pageData, perspective } = await loadQuery({
  query: pageQuery,
  params: { slug },
  cookies: Astro.cookies
});

const isDraftMode = perspective === 'previewDrafts';

if (!pageData && !isDraftMode) {
  return Astro.redirect('/404');
}

// Mapear los componentes a los bloques
const blockComponents = {
  hero: HeroBlock,
  splitImage: SplitImageBlock,
  features: FeaturesBlock,
  faqs: FaqsBlock,
};
---
<Layout>
  {isDraftMode && (
    <div style="position: fixed; top: 0; left: 0; right: 0; background: #ff4500; color: white; text-align: center; padding: 0.5em; z-index: 9999;">
      Draft Mode
    </div>
  )}
  {pageData && pageData.content ? (
    pageData.content.map((bloque) => {
      const BlockComponent = blockComponents[bloque._type];
      return BlockComponent ? (
        <BlockComponent {...bloque} />
      ) : null;
    })
  ) : (
    <p>No content available {isDraftMode ? 'in draft' : ''}</p>
  )}
</Layout>

<script define:vars={{ slug, perspective, isDraftMode }}>
  console.log('Slug:', slug);
  console.log('Perspective:', perspective);
  console.log('Is Draft Mode:', isDraftMode);
</script>