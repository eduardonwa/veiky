---
import { loadQuery } from '../sanity/lib/load-query'
import { pageQuery } from '../sanity/lib/queries';
import Layout from "../layouts/Layout.astro";
import HeroBlock from "../components/HeroBlock.astro";
import SplitImageBlock from "../components/SplitImageBlock.astro";
import FeaturesBlock from "../components/FeaturesBlock.astro";
import FaqsBlock from "../components/FaqsBlock.astro";
import CardBlock from "../components/CardBlock.astro";
import CardSetBlock from "../components/CardSetBlock.astro";
import StaticGallery from '../components/StaticGallery.astro';

// definir enabled para ver si preview esta o no en la URI
let enabled
const referrer = Astro.url.href
// si preview esta en la URI, mostrar borradores
if (referrer.includes('preview')) {enabled = 'true'} else {enabled = 'false'}

const { slug } = Astro.params;

// Cargar los datos usando loadQuery
const { data: pageData } = await loadQuery({
  query: pageQuery,
  params: { slug },
  enabled,
});

console.log("Datos obtenidos:", pageData);

if (!pageData || !pageData.content || !Array.isArray(pageData.content)) {
    return Astro.redirect('/404');
}

// Mapear los componentes a los bloques
const blockComponents = {
  hero: HeroBlock,
  splitImage: SplitImageBlock,
  features: FeaturesBlock,
  faqs: FaqsBlock,
  card: CardBlock,
  cardSet: CardSetBlock,
  staticGallery: StaticGallery,
};
---

<Layout>
  {pageData.content.map((bloque) => {
    const BlockComponent = blockComponents[bloque._type];
    return BlockComponent ? (
      <BlockComponent {...bloque} />
    ) : null;
  })}
</Layout>